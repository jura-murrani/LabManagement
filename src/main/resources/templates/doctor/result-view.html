<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Result Details - LabSync</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">
<div class="container mt-4">
    <div class="d-flex align-items-center gap-3 mb-3">
        <a th:href="@{/doctor/results}" class="btn btn-secondary"><i class="fas fa-arrow-left me-1"></i>Go Back</a>
        <h2 class="mb-0 page-title"><i class="fas fa-file-medical me-2"></i>Analysis Result Details</h2>
    </div>
    
    <div th:if="${param.notesAdded}" class="alert alert-success">
        <i class="fas fa-check-circle me-2"></i>Notes added successfully! Result is now visible to patient.
    </div>
    
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-user-injured me-2"></i>Patient Information</h5>
            <p><i class="fas fa-user me-2"></i><strong>Patient:</strong> <span th:text="${result.analysisOrder.patient.firstName + ' ' + result.analysisOrder.patient.lastName}"></span></p>
            <p><i class="fas fa-vial me-2"></i><strong>Examination Type:</strong> <span th:text="${result.analysisOrder.examinationType.name}"></span></p>
            <p><i class="fas fa-calendar me-2"></i><strong>Ordered At:</strong> <span th:text="${#temporals.format(result.analysisOrder.orderedAt, 'dd/MM/yyyy HH:mm')}"></span></p>
            <p th:if="${result.analysisOrder.completedAt != null}"><i class="fas fa-check-circle me-2"></i><strong>Finished Date:</strong> <span th:text="${#temporals.format(result.analysisOrder.completedAt, 'dd/MM/yyyy HH:mm')}"></span></p>
        </div>
    </div>
    
    <!-- Template-based results (multiple fields) -->
    <div th:if="${result.resultFields != null && !result.resultFields.isEmpty()}" class="card mb-3">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-flask me-2"></i>Lab Results</h5>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 30%;"><i class="fas fa-vial me-2"></i>Test</th>
                            <th style="width: 25%;"><i class="fas fa-clipboard-list me-2"></i>Result</th>
                            <th style="width: 20%;"><i class="fas fa-ruler me-2"></i>Unit</th>
                            <th style="width: 25%;"><i class="fas fa-chart-line me-2"></i>Reference Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="field : ${result.resultFields}">
                            <td><strong th:text="${field.fieldName}"></strong></td>
                            <td th:text="${field.resultValue}"></td>
                            <td th:text="${field.unit != null && !field.unit.isEmpty() ? field.unit : ''}"></td>
                            <td th:text="${field.referenceRange != null && !field.referenceRange.isEmpty() ? field.referenceRange : ''}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p th:if="${result.comment != null && !result.comment.isEmpty()}" class="mt-3 mb-1"><i class="fas fa-comment me-2"></i><strong>Lab Tech Comment:</strong> <span th:text="${result.comment}"></span></p>
            <p class="mb-0"><i class="fas fa-microscope me-2"></i><strong>Lab Technician:</strong> <span th:text="${result.labTech != null ? result.labTech.firstName + ' ' + result.labTech.lastName : 'N/A'}"></span></p>
        </div>
    </div>
    
    <!-- Legacy single-field result (fallback) -->
    <div th:if="${result.resultFields == null || result.resultFields.isEmpty()}" class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Lab Results</h5>
            <p><strong>Result Data:</strong> <span th:text="${result.resultData != null ? result.resultData : ''}"></span></p>
            <p th:if="${result.unit != null && !result.unit.isEmpty() or (result.analysisOrder != null and result.analysisOrder.examinationType != null and result.analysisOrder.examinationType.unit != null and !result.analysisOrder.examinationType.unit.isEmpty())}">
                <strong>Unit:</strong>
                <span th:text="${result.unit != null && !result.unit.isEmpty() ? result.unit : (result.analysisOrder != null && result.analysisOrder.examinationType != null ? result.analysisOrder.examinationType.unit : '')}"></span>
            </p>
            <p th:if="${result.referenceRange != null && !result.referenceRange.isEmpty() or (result.analysisOrder != null and result.analysisOrder.examinationType != null and result.analysisOrder.examinationType.referenceRange != null and !result.analysisOrder.examinationType.referenceRange.isEmpty())}">
                <strong>Reference Range:</strong>
                <span th:text="${result.referenceRange != null && !result.referenceRange.isEmpty() ? result.referenceRange : (result.analysisOrder != null && result.analysisOrder.examinationType != null ? result.analysisOrder.examinationType.referenceRange : '')}"></span>
            </p>
            <p th:if="${result.comment != null && !result.comment.isEmpty()}"><strong>Lab Tech Comment:</strong> <span th:text="${result.comment}"></span></p>
            <p class="mb-0"><strong>Lab Technician:</strong> <span th:text="${result.labTech != null ? result.labTech.firstName + ' ' + result.labTech.lastName : 'N/A'}"></span></p>
        </div>
    </div>
    
    <!-- Doctor Notes with Edit/Save functionality -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-stethoscope me-2"></i>Doctor Notes</h5>
            <form th:action="@{/doctor/results/{id}/notes(id=${result.id})}" method="post" id="doctorNotesForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="mb-3">
                    <textarea class="form-control" id="doctorNotes" name="doctorNotes" rows="4" 
                              th:text="${result.doctorNotes != null ? result.doctorNotes : ''}"
                              readonly></textarea>
                    <small class="form-text text-muted">Adding notes will make this result visible to the patient.</small>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" id="editNotesBtn" onclick="enableEdit()"><i class="fas fa-edit me-1"></i>Edit</button>
                    <button type="submit" class="btn btn-primary" id="saveNotesBtn" style="display: none;"><i class="fas fa-save me-1"></i>Save</button>
                    <button type="button" class="btn btn-secondary" id="cancelNotesBtn" style="display: none;" onclick="cancelEdit()"><i class="fas fa-times me-1"></i>Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    
    <script>
        let originalNotes = '';
        
        function enableEdit() {
            const textarea = document.getElementById('doctorNotes');
            const editBtn = document.getElementById('editNotesBtn');
            const saveBtn = document.getElementById('saveNotesBtn');
            const cancelBtn = document.getElementById('cancelNotesBtn');
            
            originalNotes = textarea.value;
            textarea.readOnly = false;
            textarea.focus();
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
        }
        
        function cancelEdit() {
            const textarea = document.getElementById('doctorNotes');
            const editBtn = document.getElementById('editNotesBtn');
            const saveBtn = document.getElementById('saveNotesBtn');
            const cancelBtn = document.getElementById('cancelNotesBtn');
            
            textarea.value = originalNotes;
            textarea.readOnly = true;
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }
    </script>
</div>
</body>
</html>

