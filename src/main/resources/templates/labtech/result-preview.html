<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview Analysis Result - LabSync</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .info-box {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .info-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .info-value {
            color: #666;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <div class="d-flex align-items-center gap-3 mb-4">
        <a th:href="@{/labtech/orders}" class="btn btn-secondary">Back to Orders</a>
        <h2 class="mb-0">TEST RESULTS</h2>
    </div>
    
    <!-- Patient Information -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-2">
                    <strong>Name:</strong> <span th:text="${order.patient.firstName + ' ' + (order.patient.fathersName != null ? order.patient.fathersName + ' ' : '') + order.patient.lastName}"></span>
            </div>
                <div class="col-md-2 mb-2">
                    <strong>Age:</strong> <span th:text="${order.patient.yearsOld + ' years old'}"></span>
            </div>
                <div class="col-md-2 mb-2">
                    <strong>Sex:</strong> <span th:text="${order.patient.gender}"></span>
            </div>
                <div class="col-md-2 mb-2">
                    <strong>Date:</strong> <span th:text="${order.orderedAt != null ? #temporals.format(order.orderedAt, 'yyyy-MM-dd') : 'N/A'}"></span>
        </div>
                <div class="col-md-3 mb-2">
                    <strong>Patient #:</strong> <span th:text="${order.patient.idNumber}"></span>
            </div>
            </div>
        </div>
    </div>
    
    <!-- Template-based results -->
    <div th:if="${hasTemplate == true && result != null && result.resultFields != null && !result.resultFields.isEmpty()}" class="card mb-3">
        <div class="card-header text-white" style="background-color: #0d6efd;">
            <h5 class="mb-0">Examination types</h5>
        </div>
        <div class="card-body">
            <div class="mb-2" th:if="${order.examinationType.examinationCategory != null}">
                <h6 class="text-primary" th:text="${order.examinationType.examinationCategory.name}"></h6>
            </div>
            <div class="mb-3">
                <h6 class="text-muted" th:text="${order.examinationType.name}"></h6>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40%;">Test</th>
                            <th style="width: 30%;">Results</th>
                            <th style="width: 30%;">Reference Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="field : ${result.resultFields}">
                            <td>
                                <strong th:text="${field.fieldName}"></strong>
                                <small th:if="${field.unit != null && !field.unit.isEmpty()}" class="text-muted d-block" th:text="'(' + ${field.unit} + ')'"></small>
                            </td>
                            <td th:text="${field.resultValue}"></td>
                            <td>
                                <span th:text="${field.referenceRange != null && !field.referenceRange.trim().isEmpty() ? field.referenceRange : ''}"></span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Legacy single-field result -->
    <div th:if="${hasTemplate == false && result != null}" class="card mb-3">
        <div class="card-header text-white" style="background-color: #0d6efd;">
            <h5 class="mb-0">Examination types</h5>
        </div>
        <div class="card-body">
            <div class="mb-2" th:if="${order.examinationType.examinationCategory != null}">
                <h6 class="text-primary" th:text="${order.examinationType.examinationCategory.name}"></h6>
            </div>
            <div class="mb-3">
                <h6 class="text-muted" th:text="${order.examinationType.name}"></h6>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40%;">Test</th>
                            <th style="width: 30%;">Results</th>
                            <th style="width: 30%;">Reference Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <strong th:text="${order.examinationType.name}"></strong>
                                <small th:if="${result.unit != null && !result.unit.isEmpty()}" class="text-muted d-block" th:text="'(' + ${result.unit} + ')'"></small>
                            </td>
                            <td th:text="${result.resultData}"></td>
                            <td>
                                <span th:text="${result.referenceRange != null && !result.referenceRange.trim().isEmpty() ? result.referenceRange : (order.examinationType.referenceRange != null && !order.examinationType.referenceRange.trim().isEmpty() ? order.examinationType.referenceRange : '')}"></span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div th:if="${result != null && result.comment != null && !result.comment.isEmpty()}" class="card mb-3">
        <div class="card-body">
            <h6 class="card-title">Comment</h6>
            <p th:text="${result.comment}"></p>
        </div>
    </div>
    
    <!-- Lab Technician Name at the end -->
    <div class="mt-4 text-end mb-3">
        <p class="mb-0"><strong>Lab Technician:</strong> 
            <span th:if="${result != null && result.labTech != null}" 
                  th:text="${result.labTech.firstName + ' ' + result.labTech.lastName}"></span>
            <span th:if="${result == null || result.labTech == null}" 
                  th:text="${labTech != null ? labTech.firstName + ' ' + labTech.lastName : 'N/A'}"></span>
        </p>
    </div>
</div>
</body>
</html>

