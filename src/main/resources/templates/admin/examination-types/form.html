<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examination Type Form - LabSync</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .field-row-actions {
            text-align: center;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 th:text="${examinationTypeForm.id != null ? 'Edit Examination Type' : 'Add New Examination Type'}">Examination Type Form</h2>
        <a th:href="@{/admin/dashboard}" class="btn btn-secondary">Go Back to Dashboard</a>
    </div>
    
    <div th:if="${#lists.isEmpty(categories)}" class="alert alert-warning">
        <strong>Warning:</strong> No examination categories available. You must create categories first before adding examination types.
        <a th:href="@{/admin/examination-categories/new}" class="alert-link">Create Category</a>
    </div>
    
    <form th:action="@{/admin/examination-types/save}" th:object="${examinationTypeForm}" method="post" class="mt-4">
        <input type="hidden" th:field="*{id}"/>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        
        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">
            <ul>
                <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
            </ul>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="name" class="form-label">Name *</label>
                <input type="text" class="form-control" id="name" th:field="*{name}" required/>
                <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="text-danger"></span>
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="categoryId" class="form-label">Category *</label>
                <select class="form-control" id="categoryId" th:field="*{categoryId}" required>
                    <option value="">Select Category</option>
                    <option th:each="cat : ${categories}" 
                            th:value="${cat.id}" 
                            th:selected="${examinationTypeForm.categoryId != null && examinationTypeForm.categoryId == cat.id}"
                            th:text="${cat.name}"></option>
                </select>
                <span th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}" class="text-danger"></span>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" th:field="*{description}" rows="3"></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="unit" class="form-label">Unit</label>
                <input type="text" class="form-control" id="unit" th:field="*{unit}"/>
            </div>
            
            <div class="col-md-6 mb-3">
                <label for="referenceRange" class="form-label">Reference Range</label>
                <input type="text" class="form-control" id="referenceRange" th:field="*{referenceRange}"/>
            </div>
        </div>
        
        <!-- Examination Fields Section -->
        <div class="card mb-4">
            <div class="card-header text-white" style="background-color: #0d6efd;">
                <h5 class="mb-0">Examination types</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <p class="text-muted mb-2">Define the test fields for this examination type. Each field will appear as a row in the lab technician's result form.</p>
                    <button type="button" class="btn btn-success btn-sm" onclick="addFieldRow()">
                        <i class="fas fa-plus me-1"></i>Add Field
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered" id="fieldsTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 45%;">Test</th>
                                <th style="width: 30%;">Reference Range</th>
                                <th style="width: 20%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fieldsTableBody">
                            <!-- Fields will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Hidden field to store JSON data -->
        <input type="hidden" id="fieldsData" name="fieldsData" th:value="${fieldsData != null ? fieldsData : '[]'}"/>
        <script th:inline="javascript">
            /*<![CDATA[*/
            window.initialFieldsData = /*[[${fieldsData != null ? fieldsData : '[]'}]]*/ '[]';
            /*]]>*/
        </script>
        
        <button type="submit" class="btn btn-primary" onclick="saveFieldsData()">
            <i class="fas fa-save me-1"></i>Save
        </button>
        <a th:href="@{/admin/examination-types}" class="btn btn-secondary">Cancel</a>
        <a th:href="@{/admin/dashboard}" class="btn btn-secondary">Go Back to Dashboard</a>
    </form>
</div>

<script>
    let fieldCounter = 0;
    let fieldsData = [];
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        // Load existing fields if editing
        var initialFieldsData = window.initialFieldsData || '[]';
        console.log('Initial fields data:', initialFieldsData);
        
        if (initialFieldsData && initialFieldsData !== '[]' && initialFieldsData.trim() !== '' && initialFieldsData !== 'null' && initialFieldsData !== 'undefined') {
            try {
                var parsed = JSON.parse(initialFieldsData);
                console.log('Parsed fields:', parsed);
                if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                    parsed.forEach(function(field) {
                        console.log('Adding field:', field);
                        addFieldRow(field.name || '', field.unit || '', field.referenceRange || '');
                    });
                } else {
                    // If no fields exist, add one empty row
                    addFieldRow();
                }
            } catch(e) {
                console.error('Error parsing fields data:', e, 'Raw data:', initialFieldsData);
                addFieldRow();
            }
        } else {
            // If no fields data, add one empty row
            addFieldRow();
        }
    });
    
    function addFieldRow(name = '', unit = '', referenceRange = '') {
        const tbody = document.getElementById('fieldsTableBody');
        const row = document.createElement('tr');
        const currentId = 'fieldRow' + fieldCounter;
        row.id = currentId;
        
        // Escape values for HTML
        const escapedName = escapeHtml(name || '');
        const escapedUnit = escapeHtml(unit || '');
        const escapedRange = escapeHtml(referenceRange || '');
        
        row.innerHTML = `
            <td>
                <div class="row g-2">
                    <div class="col-8">
                        <input type="text" class="form-control form-control-sm field-name" 
                               placeholder="e.g., insulin" 
                               value="${escapedName}" required>
                    </div>
                    <div class="col-4">
                        <input type="text" class="form-control form-control-sm field-unit" 
                               placeholder="e.g., mg/dl" 
                               value="${escapedUnit}">
                    </div>
                </div>
                <small class="text-muted">Format: name (unit) - e.g., "insulin (mg/dl)"</small>
            </td>
            <td>
                <input type="text" class="form-control form-control-sm field-range" 
                       placeholder="e.g., <1.8" 
                       value="${escapedRange}">
            </td>
            <td class="field-row-actions">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeFieldRowById('${currentId}')" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        fieldCounter++;
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    function removeFieldRowById(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
        }
    }
    
    function saveFieldsData() {
        const rows = document.querySelectorAll('#fieldsTableBody tr');
        fieldsData = [];
        
        rows.forEach((row) => {
            const nameInput = row.querySelector('.field-name');
            const unitInput = row.querySelector('.field-unit');
            const rangeInput = row.querySelector('.field-range');
            
            if (nameInput && unitInput && rangeInput) {
                const name = nameInput.value.trim();
                const unit = unitInput.value.trim();
                const range = rangeInput.value.trim();
                
                if (name) { // Only add if name is provided
                    fieldsData.push({
                        name: name,
                        unit: unit,
                        referenceRange: range
                    });
                }
            }
        });
        
        const hiddenField = document.getElementById('fieldsData');
        if (hiddenField) {
            hiddenField.value = JSON.stringify(fieldsData);
        }
    }
    
    // Make sure saveFieldsData is called before form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                saveFieldsData();
            });
        }
    });
</script>
</body>
</html>

